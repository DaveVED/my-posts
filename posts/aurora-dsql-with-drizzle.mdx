# Setting Up Amazon Aurora DSQL with Drizzle

Amazon recently announced the release of [Aurora DSQL](https://aws.amazon.com/blogs/database/introducing-amazon-aurora-dsql/), a significant upgrade to AWS's database offerings. Previously, Aurora was criticized for its relatively high minimum entry cost and complexity. For many use cases, the question often arose: why not just use RDS or a standard MySQL database? Aurora's overhead sometimes made it less appealing.

With the introduction of Aurora DSQL—a serverless, distributed SQL database offering virtually unlimited scale, unparalleled availability, and zero infrastructure management—AWS has addressed these concerns. Now you can design for scale without worrying about massive costs if your side project doesn’t take off. That peace of mind is a game-changer.

In this guide, I’ll walk you through configuring Aurora DSQL and integrating it with Drizzle ORM. Aurora DSQL’s simplicity makes it ideal for projects like three-tier applications, where traditional databases might struggle with scaling or cost-efficiency. For me, it’s even easier to set up than DynamoDB in some cases. That’s a big win.

---

## Creating Your First Cluster

Currently, Aurora DSQL supports PostgreSQL with functionality accessible through both the AWS CLI and SDK. While this is fantastic, I’m particularly interested in CDK support, though it doesn’t fully meet my needs just yet. For now, let’s create the cluster manually using the AWS Management Console.

Here are the steps to create your cluster:

1. **Search for Aurora DSQL**  
   - Navigate to the RDS section in the AWS Console and search for Aurora DSQL.  
   - ![Search For DSQL](https://raw.githubusercontent.com/DaveVED/my-posts/main/posts/aurora-dsql-with-drizzle/dsql-step-1.png)

2. **Input Cluster Criteria**  
   - Configure your cluster. For this walkthrough, we’ll leave linked regions off and enable deletion protection. These settings are optional for this tutorial but are highly recommended for production environments.  
   - ![Input Criteria for DSQL](https://raw.githubusercontent.com/DaveVED/my-posts/main/posts/aurora-dsql-with-drizzle/dsql-step-2.png)

3. **Wait for the Cluster to Activate**  
   - Once the cluster is created, wait until its status turns **Active**.  
   - ![Validation For DSQL](https://raw.githubusercontent.com/DaveVED/my-posts/main/posts/aurora-dsql-with-drizzle/dsql-step-3.png)
   - ![Validation For DSQL](https://raw.githubusercontent.com/DaveVED/my-posts/main/posts/aurora-dsql-with-drizzle/dsql-step-4.png)

---

## Validating the Connection via Terminal

Now that the database is created, let’s ensure it’s accessible before integrating it programmatically. This step will save you troubleshooting time later. Follow these steps:

1. **Get the Cluster Endpoint**  
   - Retrieve the endpoint from the AWS Management Console.  
   - ![Cluster Endpoint](https://raw.githubusercontent.com/DaveVED/my-posts/main/posts/aurora-dsql-with-drizzle/dsql-step-5.png)

2. **Connect to the Database**  
   - Use the following command to connect. Replace `<endpoint>` with your cluster endpoint:  
   ```bash
   PGSSLMODE=require \
   psql --dbname postgres \
   --username admin \
   --host <endpoint>
   ```
3. **Authenticate with a Temporary Token**
    - If prompted for a token, generate one via the AWS Console. Tokens are valid for 15 minutes.
    - In production, we’ll configure automatic token rotation using Drizzle ORM. For now, manually input the token.
4. **Validate the Connection**
    - Upon successful connection, you should see a prompt like this:
        ```bash
        postgres=>
       ```
       (https://raw.githubusercontent.com/DaveVED/my-posts/main/posts/aurora-dsql-with-drizzle/dsql-step-7.png)
> If you arer asked for a _password for user admin_, you can get a 15 min password by clicking connect in the console. We will handle the rotation of this in drizzle later.
> ![Cluster Password](https://raw.githubusercontent.com/DaveVED/my-posts/main/posts/aurora-dsql-with-drizzle/dsql-step-6.png)

If you’ve reached this step, your Aurora DSQL database is ready for integration!

## Configureing Drizzle

Now that we know we can setup and connect to a to a cluster let's setup drizzle, i'm going to use dirzzle at this point to create everyting I need, but i'll proivde teh SQL if you dont' want to take that route, at which point you can run that , and just test teh orm at the end, but i'm on a code first kick.

## Setting Up the Project

### Project Structure

Here’s an example of the basic project structure:

```bash
.
├── bun.lockb
├── drizzle.config.ts
├── package.json
├── README.md
├── src
│   ├── db
│   │   ├── posts.ts
│   │   ├── index.ts
│   │   └── schema.ts
├── tsconfig.json
└── tsup.config.ts

#### Initial Setup

We’re using bun for this setup, but tools like pnpm would also work. To get started:

    1. Initialize the project:
    ```bash
    bun init
    ```
    2. Bootstrap your TypeScript project.
    3. Validate and create the necessary configuration files:

##### tsconfig.json

```json
{
  "extends": "@tsconfig/node20/tsconfig.json",
  "compilerOptions": {
    "declaration": true,
    "module": "nodenext",
    "target": "esnext",
    "moduleResolution": "nodenext",
    "outDir": "./dist",
    "allowSyntheticDefaultImports": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src"],
  "exclude": ["test", "dist"]
}
```

###### tsup.config.ts

```typescript
import { defineConfig, type Options } from "tsup";

export default defineConfig((options: Options) => ({
  entryPoints: ["src/app.local.ts"],
  clean: true,
  format: ["cjs"],
  ...options,
}));
```

###### package.json

```json
{
  "name": "@dsqr/api",
  "version": "0.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "start": "node dist/index.js",
    "dev": "tsup --watch --onSuccess \"node dist/app.local.cjs\"",
    "build": "tsup",
    "clean": "rm -rf dist",
    "typecheck": "tsc --noEmit",
    "lint": "eslint src/"
  },
  "devDependencies": {
    "tsup": "^8.0.2",
    "typescript": "^5.3.3"
  }
}
```

#### Setting Up the Database

1. To start working on the database, install the required dependencies:

##### Install Dependencies
    
    1. Add the main dependencies:
    ```bash
    bun add drizzle-orm pg dotenv
    ```
    2. Add the development dependencies:
    ```bash
    bun add -D drizzle-kit tsx @types/pg
    ```