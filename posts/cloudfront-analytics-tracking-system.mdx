---
title: 'Your Title Here'
date: '2024-07-04'
---

# Next.js CloudFront Analytics

I've been exploring [Next.js](https://nextjs.org/) recently and looking for ways
to gather visitor analytics on my personal site
[davedennis.dev](https://davedennis.dev). While Next.js, developed by Vercel,
suggests deploying to [Vercel](https://vercel.com/docs/deployments/overview),
which offers built-in [observability](https://vercel.com/products/observability)
features and the handy [@vercel/analytics](https://github.com/vercel/analytics)
package, I chose to deploy on **Amazon Web Services** instead.

## Overview

While initially developed for my personal site, this package is designed to work
for anyone with CloudFront logging enabled. You can use it to gather visitor
analytics effectively.

## My Architecture

The project began with a simple goal: to collect analytics for my personal site.
It consists of two phases.

### Phase 1 - CloudFront + S3

This phase focuses on static site deployment.

### Phase 2 - CloudFront + ALB + ECS

I moved to this setup to support server-side rendering (SSR). Although
[generateStaticParams](https://nextjs.org/docs/app/api-reference/functions/generate-static-params)
is a great feature, I preferred an SSR approach for better content rendering.
Additionally, having `output: "export"` in my `next.config.mjs` file, necessary
for static site deployment to S3, didn't suit my preferences.

## What's Required

To make this work, you need:

1. A CloudFront distribution with standard logging enabled.

Here's a basic configuration to get you started.

## Logging Format

I download a random `:fileName.gz` file from s3 and unziped it. The content for
the basic standard logging looks like this.

| **Date**   | **Time** | **IP Address** | **Request Path**                                   | **Status** | **Referer**    | **User-Agent** | **Time Taken** | **Response Type** | **Content Type**       | **Content Length** |
| ---------- | -------- | -------------- | -------------------------------------------------- | ---------- | -------------- | -------------- | -------------- | ----------------- | ---------------------- | ------------------ |
| 2024-06-29 | 22:55:09 | 98.156.200.9   | /                                                  | 200        | -              | Firefox/123.0  | 0.154          | Miss              | text/html              | 8187               |
| 2024-06-29 | 22:55:09 | 98.156.200.9   | /\_next/static/chunks/255-72dab6264202d01c.js      | 200        | davedennis.dev | Firefox/123.0  | 0.153          | Miss              | application/javascript | 16461              |
| 2024-06-29 | 22:55:09 | 98.156.200.9   | /\_next/static/chunks/main-app-94f59e14a73e27df.js | 200        | davedennis.dev | Firefox/123.0  | 0.157          | Miss              | application/javascript | 416                |
| 2024-06-29 | 22:55:09 | 98.156.200.9   | /\_next/static/chunks/app/page-b280886ff65fa5fb.js | 200        | davedennis.dev | Firefox/123.0  | 0.159          | Miss              | application/javascript | 5357               |
| 2024-06-29 | 22:55:09 | 98.156.200.9   | /\_next/static/chunks/webpack-74cf08070cb387b7.js  | 200        | davedennis.dev | Firefox/123.0  | 0.167          | Miss              | application/javascript | 3395               |
| 2024-06-29 | 22:55:09 | 98.156.200.9   | /\_next/static/css/8900bd1871c8812b.css            | 200        | davedennis.dev | Firefox/123.0  | 0.178          | Miss              | text/css               | 30972              |
| 2024-06-29 | 22:55:09 | 98.156.200.9   | /\_next/static/chunks/322-1a1f7ebb99c6007c.js      | 200        | davedennis.dev | Firefox/123.0  | 0.234          | Miss              | application/javascript | 137574             |
| 2024-06-29 | 22:55:09 | 98.156.200.9   | /\_next/static/chunks/c5321436-2ea2763b7f8b53c1.js | 200        | davedennis.dev | Firefox/123.0  | 0.270          | Miss              | application/javascript | 163482             |
| 2024-06-29 | 22:55:10 | 98.156.200.9   | /\_next/static/media/dave.bece728a.jpg             | 200        | davedennis.dev | Firefox/123.0  | 0.305          | Miss              | image/jpeg             | 931246             |
| 2024-06-29 | 22:55:10 | 98.156.200.9   | /path/to/hardcoded-image.jpg                       | 403        | davedennis.dev | Firefox/123.0  | 0.166          | Error             | application/xml        | -                  |
| 2024-06-29 | 22:55:10 | 98.156.200.9   | /recordplayer.mp4                                  | 206        | davedennis.dev | Firefox/123.0  | 0.822          | Miss              | video/mp4              | 53385729           |
| 2024-06-29 | 22:55:10 | 98.156.200.9   | /favicon.ico                                       | 200        | davedennis.dev | Firefox/123.0  | 0.190          | Miss              | image/x-icon           | 25931              |

### Breakdown of Log Components

| **Component**      | **Description**                                            |
| ------------------ | ---------------------------------------------------------- |
| **Date & Time**    | The date and time of the request.                          |
| **IP Address**     | The IP address of the requester.                           |
| **Request Path**   | The path of the resource requested.                        |
| **Status**         | HTTP status code of the response.                          |
| **Referer**        | The referring URL.                                         |
| **User-Agent**     | Information about the userâ€™s browser and operating system. |
| **Time Taken**     | Time taken to serve the request.                           |
| **Response Type**  | Indicates whether the content was cached (Miss/Error).     |
| **Content Type**   | Type of the content served (e.g., HTML, CSS, JS, JPEG).    |
| **Content Length** | Length of the content served, in bytes.                    |

### S3 Select Query Results

If you want a quicker way to analyzie this, you can always use s3 select
(granted there is a cost assocaited to this, so use at your own rist.) I ran the
following query to just validate.

```sql
SELECT * FROM s3object s LIMIT 5
```

which proivded we with the sample results.

| **Date**   | **Time** | **Location** | **Bytes** | **IP Address** | **Method** | **Domain**                   | **Request Path**                                   | **Status** | **Referer**             | **User-Agent**                                                         | **Total Time** | **Cache** | **Host Header** | **Protocol** | **Request ID**                                           | **Origin Host** | **Connection** | **Response Time** | **Cache Type** | **TLS Version** | **Cipher Suite**       | **Cache Miss** | **HTTP Version** | **Origin Time** | **Origin Connect** | **Content Length** | **Response Duration** | **Cache Key** | **Session ID** | **Response Error** |
| ---------- | -------- | ------------ | --------- | -------------- | ---------- | ---------------------------- | -------------------------------------------------- | ---------- | ----------------------- | ---------------------------------------------------------------------- | -------------- | --------- | --------------- | ------------ | -------------------------------------------------------- | --------------- | -------------- | ----------------- | -------------- | --------------- | ---------------------- | -------------- | ---------------- | --------------- | ------------------ | ------------------ | --------------------- | ------------- | -------------- | ------------------ |
| 2024-06-29 | 22:52:56 | DFW56-P5     | 329       | 98.156.200.9   | GET        | d38pnvq3ar944.cloudfront.net | /                                                  | 304        | -                       | Mozilla/5.0 (X11; Linux x86_64; rv:123.0) Gecko/20100101 Firefox/123.0 | 0.149          | Miss      | davedennis.dev  | https        | 9e6CHhMlsLEHXvFtVpTYGdo4PR4nCVFKtPuyYL3wzaPJJjRbwDKjeg== | davedennis.dev  | https          | 328               | 0.149          | TLSv1.3         | TLS_AES_128_GCM_SHA256 | Miss           | HTTP/2.0         | -               | -                  | 37822              | 0.149                 | Miss          | -              | -                  |
| 2024-06-29 | 22:52:56 | DFW56-P5     | 329       | 98.156.200.9   | GET        | d38pnvq3ar944.cloudfront.net | /\_next/static/css/8900bd1871c8812b.css            | 304        | https://davedennis.dev/ | Mozilla/5.0 (X11; Linux x86_64; rv:123.0) Gecko/20100101 Firefox/123.0 | 0.145          | Miss      | davedennis.dev  | https        | CN-S3kgx5OnJ5rwjv8X2ntBgwFIR5V1mmgQOYtNBE07dr3w9oPHPHg== | davedennis.dev  | https          | 160               | 0.145          | TLSv1.3         | TLS_AES_128_GCM_SHA256 | Miss           | HTTP/2.0         | -               | -                  | 37822              | 0.145                 | Miss          | -              | -                  |
| 2024-06-29 | 22:52:56 | DFW56-P5     | 328       | 98.156.200.9   | GET        | d38pnvq3ar944.cloudfront.net | /\_next/static/chunks/webpack-74cf08070cb387b7.js  | 304        | https://davedennis.dev/ | Mozilla/5.0 (X11; Linux x86_64; rv:123.0) Gecko/20100101 Firefox/123.0 | 0.148          | Miss      | davedennis.dev  | https        | Uji7fu-wsox1oiN4ZGLa69AuZi_vUZvDZ95B4QfdPMfKjSb3-znYgg== | davedennis.dev  | https          | 122               | 0.148          | TLSv1.3         | TLS_AES_128_GCM_SHA256 | Miss           | HTTP/2.0         | -               | -                  | 37822              | 0.148                 | Miss          | -              | -                  |
| 2024-06-29 | 22:52:56 | DFW56-P5     | 330       | 98.156.200.9   | GET        | d38pnvq3ar944.cloudfront.net | /\_next/static/chunks/255-72dab6264202d01c.js      | 304        | https://davedennis.dev/ | Mozilla/5.0 (X11; Linux x86_64; rv:123.0) Gecko/20100101 Firefox/123.0 | 0.147          | Miss      | davedennis.dev  | https        | lPM1Z1dwJWOOfTsOszLvRCJnO2TC26hm4cXDUbkydDG3vi0lSDBWKQ== | davedennis.dev  | https          | 84                | 0.147          | TLSv1.3         | TLS_AES_128_GCM_SHA256 | Miss           | HTTP/2.0         | -               | -                  | 37822              | 0.147                 | Miss          | -              | -                  |
| 2024-06-29 | 22:52:56 | DFW56-P5     | 329       | 98.156.200.9   | GET        | d38pnvq3ar944.cloudfront.net | /\_next/static/chunks/c5321436-2ea2763b7f8b53c1.js | 304        | https://davedennis.dev/ | Mozilla/5.0 (X11; Linux x86_64; rv:123.0) Gecko/20100101 Firefox/123.0 | 0.150          | Miss      | davedennis.dev  | https        | VxnatytQF5nZmeLUjayKL-VWjD1JVwSHjFOh835RIC9yHr1HVJMlYA== | davedennis.dev  | https          | 111               | 0.150          | TLSv1.3         | TLS_AES_128_GCM_SHA256 | Miss           | HTTP/2.0         | -               | -                  | 37822              | 0.150                 | Miss          | -              | -                  |

## Conclusion

This architecture allows for efficient analytics gathering on AWS, making it a
great solution for anyone looking to move beyond static site deployment.
